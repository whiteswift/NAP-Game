<!DOCTYPE html>
<html>
<head>
	<title>Higher or Lower</title>
	<link rel="stylesheet" href="bootstrap-3.3.5-dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="bootstrap-3.3.5-dist/css/bootstrap-theme.min.css">
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8" /> <!-- To stop pound signs showing up like weird characters -->
	<style>
	.img{
		height: 300px;
	}
	.center{
		text-align: center;
	}
	.description{
		font-size: 12px;
  	font-style: italic;
		overflow: scroll;
		height: 100px;
	}
	#overlay {
		visibility: hidden;
		position: absolute;
		left: 0px;
		top: 0vw;
		width: 100%;
		height: 100%;
		text-align: center;
		background: rgba(55, 55, 55, 0.75);
		z-index: 1000;
		color: white;
		padding: 8vw;
	}
	#overlay-text {
		font-size: 3vw;
	}
	#overlay > div > button {
		color: #484848;
		background: white;
		border-radius: 5px;
		border: 1px solid grey;
		width: 10.5vw;
		height: 2.5vw;
		font-family: gillsans;
		font-size: 1vw;
		cursor: pointer;
		text-transform: uppercase;
	}
	</style>
</head>
<body>

	<div class="container">
		<div class="row">
			<div class="col-xs-12">
				<h1>Higher or Lower game</h1>
				<h4>Which product costs more?</h4>
			</div>
		</div>
		<div class='row'>
			<div class="col-xs-12">
				<p class="label label-success">Score: <span id='score'>0</span></p>
			</div>
		</div>

		<div class="row">
			<div class="col-xs-6">
				<img id='image1' class="pic1 img" src="images/product_image.jpg" alt="Product 1">
			</div>
			<div class="col-xs-6">
				<img id='image2' class="pic2 img" src="images/product_image.jpg" alt="Product 2">
			</div>
		</div>

		<div class="row">
			<div class="col-xs-6">
				<div id='p1Name'>
					... Loading Name
				</div>
			</div>
			<div class="col-xs-6">
				<div id='p2Name'>
					... Loading Name
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-xs-6">
				<div id='p1Description' class="description">
					... Loading Description
				</div>
				<div id="p1Price" data-price=''></div>
			</div>
			<div class="col-xs-6">
				<div id='p2Description' class="description">
					... Loading Description
				</div>
				<div id="p2Price" data-price=''></div>
			</div>
		</div>

		<div class='row'>
			<div class='col-xs-6'>
				<button id='A' type="button" class="btn btn-primary btn-lg high-low" data-product="A">A</button>
			</div>
			<div class='col-xs-6'>
				<button id='B' type="button" class="btn btn-primary btn-lg high-low" data-product="B">B</button>
			</div>
		</div>

	</div>

	<div id="overlay">
	  <div>
	      <p id='overlay-text'>Loading message...</p>
				<button>Dismiss</button>
	  </div>
 	</div>

	<script>

var score = 0;
var pids = [];
var pid;
var shot;
var size;
var imageURL;
var name;
var designer;
var description;
var price;

(function(){ // When page is ready, run this code.
	getNewProducts(); // Start new game
})();

function getNewProducts(){

	var offset = _getRandomOffset();

	fetch('http://lad-api.net-a-porter.com:80/NAP/GB/60/'+offset+'/pids').then(
		function(pidsResponse) {
			if (pidsResponse.status !== 200) {
				console.log('ʕノ•ᴥ•ʔノ ︵ ┻━┻ fetch failed',pidsResponse.status);
				return;
			}

			pidsResponse.json().then(function(pidData) {
				// Clear the pids array
				randomNumbers = []; // [345435, 543545]

				// Get two randomNumbers from data
				randomNumbers[0] = _getRandomNumber(0,59);
				randomNumbers[1] = _getRandomNumber(0,59);

				// Make sure they are not the same
				while(randomNumbers[0] === randomNumbers[1]) {
						randomNumbers[0] = _getRandomNumber(0,59);
						randomNumbers[1] = _getRandomNumber(0,59);
				}

				pids[0] = pidData.pids[randomNumbers[0]];
				pids[1] = pidData.pids[randomNumbers[1]];

				// set off product 1 promise
				fetch('http://lad-api.net-a-porter.com:80/NAP/GB/en/detail/'+pids[0]).then(
					function(productDataResponse){
						if (productDataResponse.status !== 200) {
							console.log('ʕノ•ᴥ•ʔノ ︵ ┻━┻ fetch failed',productDataResponse.status);
							return;
						}

						productDataResponse.json().then(function(productData) {
							pid = productData.id;
							shot = productData.images.shots[0];
							size = productData.images.sizes[0];
							imageURL = "http://cache.net-a-porter.com/images/products/"+pid+"/"+pid+"_"+shot+"_"+size+".jpg";
							name = productData.name;
							designer = productData.brand.name;
							description = productData.editorsComments;
							price = btoa(productData.price.amount);

							document.getElementById('p1Name').innerHTML = '<p><b>'+designer+'</b></p><p>'+name+'</p>';
							document.getElementById('image1').setAttribute('src',imageURL);
							document.getElementById('p1Price').setAttribute('data-price',price);
							document.getElementById('p1Description').innerHTML = description;
						});
					}
				);

				// set off product 2 promise
				fetch('http://lad-api.net-a-porter.com:80/NAP/GB/en/detail/'+pids[1]).then(
					function(productDataResponse){
						if (productDataResponse.status !== 200) {
							console.log('ʕノ•ᴥ•ʔノ ︵ ┻━┻ fetch failed',productDataResponse.status);
							return;
						}
						productDataResponse.json().then(function(productData) {
							pid = productData.id;
							shot = productData.images.shots[0];
							size = productData.images.sizes[0];
							imageURL = "http://cache.net-a-porter.com/images/products/"+pid+"/"+pid+"_"+shot+"_"+size+".jpg";
							name = productData.name;
							designer = productData.brand.name;
							description = productData.editorsComments;
							price = btoa(productData.price.amount);

							document.getElementById('p2Name').innerHTML = '<p><b>'+designer+'</b></p><p>'+name+'</p>';
							document.getElementById('image2').setAttribute('src',imageURL);
							document.getElementById('p2Price').setAttribute('data-price',price);
							document.getElementById('p2Description').innerHTML = description;
						});
					}
				);

			});
		}
	);
}

function processAnswer(element) {

	var selection = element.getAttribute('data-product'); // Retrieve whether product A or B is pressed
	var price1 = atob(document.getElementById('p1Price').getAttribute('data-price'))/100;
	var price2 = atob(document.getElementById('p2Price').getAttribute('data-price'))/100;

	if(selection === 'A' && price1 > price2) {
		document.getElementById('overlay-text').innerHTML = ('Correct! Product A: £'+ price1 +'. Product B: £'+price2);
		_addToScore();
	}
	else if(selection === 'B' && price1 < price2) {
		document.getElementById('overlay-text').innerHTML = ('Correct! Product A: £'+ price1 +'. Product B: £'+price2);
		_addToScore();
	}
	else if (price1 === price2) {
		document.getElementById('overlay-text').innerHTML = ('Same price! No points though sorry. Product A: £'+ price1 +'. Product B: £'+price2);
	}
	else {
		document.getElementById('overlay-text').innerHTML = ('ʕノ•ᴥ•ʔノ ︵ ┻━┻ <br/>Incorrect! Product A: £'+ price1 +'. Product B: £'+price2);
	}

	overlayMessage();
	getNewProducts(); // Get new products again
}

//////////////////////
// Helper functions
//////////////////////

function _getRandomOffset(){
	var offset = _getRandomNumber(0,14983);
	return offset;
}

function _getRandomNumber(min, max) {
	return Math.floor(Math.random() * (max - min) + min);
}

function _addToScore(){
	score++;
	document.getElementById('score').innerHTML = score;
}

// TODO: Need this?
function _fetchFailed(){
	console.log('ʕノ•ᴥ•ʔノ ︵ ┻━┻ fetch failed');
}

function overlayMessage() {
	el = document.getElementById("overlay");
	el.style.visibility = (el.style.visibility == "visible") ? "hidden" : "visible";
}

function isOverlayVisible() {
	el = document.getElementById("overlay");
	return el.style.visibility;
}

//////////////////////
// Event listeners
//////////////////////

[].forEach.call(document.getElementsByClassName('high-low'), function(element) {
	element.addEventListener('click', function(){ processAnswer(this); });
});

document.getElementById('overlay').addEventListener('click', function(){ overlayMessage(); });

window.addEventListener('keydown', function(event){
	if(event.keyCode === 37 || event.keyCode === 65) { // Left, A
		let button = document.getElementById('A');
		// Check if overlay is present - then return if so
		if (isOverlayVisible() !== 'visible') {
			processAnswer(button);
		}
	}
	if(event.keyCode === 39 || event.keyCode === 66) { // Right, B
		let button = document.getElementById('B');
		if (isOverlayVisible() !== 'visible') {
			processAnswer(button);
		}
	}
	if(event.keyCode === 32 && isOverlayVisible()) { // Spacebar
		overlayMessage()
	}
});


</script>
</body>
</html>
